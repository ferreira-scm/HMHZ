# This script is similar to mvabund.R but with additive effect of HI
library(phyloseq, lib="/usr/local/lib/R/site-library/")
library(mvabund)
library("iNEXT")

### multivariate analyses
## this takes WEEKS to run at the ASV level. I am starting at genus level
pPS=readRDS(file="tmp/pPSpre.R")

set.seed(1234)
PSrare <- rarefy_even_depth(pPS, sample.size=5000, replace=F)

rPSgen=tax_glom(PSrare, taxrank="genus")

rPSgen

rOTUmv <- mvabund(otu_table(rPSgen))

#mean variance relationship
meanvar.plot(rOTUmv)

# multivariate model
mod1 <- manyglm(rOTUmv ~sample_data(rPSgen)$HI +
                        sample_data(rPSgen)$BMI +
                        sample_data(rPSgen)$Sex +
                        sample_data(rPSgen)$Transect +
                        sample_data(rPSgen)$Year +
                        sample_data(rPSgen)$eimASV +
                        sample_data(rPSgen)$criASV +
                        sample_data(rPSgen)$oxyASV +
                        sample_data(rPSgen)$hexASV +
                        sample_data(rPSgen)$hymASV +
                        sample_data(rPSgen)$triASV +
                        sample_data(rPSgen)$ascASV +
                        sample_data(rPSgen)$spiASV +
                        sample_data(rPSgen)$hekASV, family="negative_binomial")

#plot(mod1)
#table1 <- summary.manyglm(mod1)
table3 <- anova.manyglm(mod1, p.uni = "adjusted", show.time="all")
#table1 <- summary.manyglm(mod1)
# this takes > 500h
sink("tmp/mlm_prel_rPSgenHI.txt")
table3
sink()
saveRDS(table3, file="tmp/manyanovatable3.RDS")
